---
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";

export async function getStaticPaths() {
    const posts = await getCollection("articles");
    return posts.map((post) => ({
        params: { slug: post.slug },
        props: post,
    }));
}
type Props = CollectionEntry<"articles">;

const post = Astro.props;
const { Content } = await post.render();
---

<Layout
    title={`${post.data.title} | Shiranai`}
    description={post.data.description}
>
    <div class="fixed top-0 left-0 w-full h-1 bg-gray-100 z-50">
        <div id="scroll-progress" class="h-full bg-black w-0"></div>
    </div>

    <article
        class="min-h-screen bg-background relative selection:bg-black selection:text-white"
    >
        <!-- Back Navigation -->
        <div class="absolute top-8 left-4 md:left-8 z-20">
            <a
                href="/articles"
                class="group inline-flex items-center gap-2 text-sm font-mono uppercase tracking-widest text-gray-500 hover:text-black transition-colors"
            >
                <span
                    class="transform group-hover:-translate-x-1 transition-transform duration-300"
                    >&larr;</span
                >
                Back
            </a>
        </div>

        <div class="container mx-auto px-4 max-w-5xl pt-32 md:pt-48 pb-12">
            <!-- Header -->
            <header class="mb-24 opacity-0 translate-y-8" id="article-header">
                <div
                    class="flex flex-wrap gap-4 items-center text-sm font-mono text-gray-400 mb-8 uppercase tracking-widest"
                >
                    <time datetime={post.data.pubDate.toISOString()}>
                        {
                            post.data.pubDate.toLocaleDateString(undefined, {
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            })
                        }
                    </time>
                    <span>/</span>
                    {
                        post.data.tags && (
                            <div class="flex gap-4">
                                {post.data.tags.map((tag) => (
                                    <span class="text-black">#{tag}</span>
                                ))}
                            </div>
                        )
                    }
                </div>

                <h1
                    class="text-4xl md:text-5xl lg:text-6xl font-heading font-bold leading-tight text-gray-900 tracking-tight mb-8"
                >
                    {post.data.title}
                </h1>

                <!-- Font Size Toolbar -->
                <div
                    class="font-mono text-xs text-gray-500 mb-8 flex items-center gap-6 border-y border-gray-100 py-3 w-fit pr-8"
                >
                    <span class="uppercase tracking-widest text-gray-400"
                        >Readability</span
                    >
                    <div class="flex items-center gap-4">
                        <button
                            id="font-decrease"
                            class="hover:text-black transition-colors p-1"
                            aria-label="Decrease font size"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><line x1="5" y1="12" x2="19" y2="12"
                                ></line></svg
                            >
                        </button>
                        <span id="font-size-display" class="w-12 text-center"
                            >100%</span
                        >
                        <button
                            id="font-increase"
                            class="hover:text-black transition-colors p-1"
                            aria-label="Increase font size"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><line x1="12" y1="5" x2="12" y2="19"
                                ></line><line x1="5" y1="12" x2="19" y2="12"
                                ></line></svg
                            >
                        </button>
                    </div>
                </div>

                {
                    post.data.heroImage && (
                        <div class="w-full h-[50vh] md:h-[70vh] relative overflow-hidden mt-12">
                            <img
                                src={post.data.heroImage}
                                alt={post.data.title}
                                class="absolute inset-0 w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-700 ease-in-out"
                            />
                        </div>
                    )
                }
            </header>

            <!-- Content -->
            <div class="opacity-0 translate-y-8" id="article-content">
                <div class="markdown-content">
                    <Content />
                </div>
            </div>

            <!-- Footer / Next Read -->
            <div class="mt-32 pt-12 border-t border-black/10">
                <a
                    href="/articles"
                    class="text-xl md:text-2xl font-bold hover:underline decoration-2 underline-offset-4"
                >
                    &larr; More Selected Works
                </a>
            </div>
        </div>
    </article>

    <script>
        import { gsap } from "gsap";
        import { ScrollTrigger } from "gsap/ScrollTrigger";
        gsap.registerPlugin(ScrollTrigger);

        // Entrance Animation
        const tl = gsap.timeline();
        tl.to("#article-header", {
            opacity: 1,
            y: 0,
            duration: 1.2,
            ease: "power3.out",
        }).to(
            "#article-content",
            {
                opacity: 1,
                y: 0,
                duration: 1,
                ease: "power3.out",
            },
            "-=0.8",
        );

        // Scroll Progress
        window.addEventListener("scroll", () => {
            const winScroll =
                document.body.scrollTop || document.documentElement.scrollTop;
            const height =
                document.documentElement.scrollHeight -
                document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            const progressBar = document.getElementById("scroll-progress");
            if (progressBar) progressBar.style.width = scrolled + "%";
        });

        // Font Size Adjustment
        const content = document.querySelector(".markdown-content");
        const display = document.getElementById("font-size-display");
        const increaseBtn = document.getElementById("font-increase");
        const decreaseBtn = document.getElementById("font-decrease");

        let currentSizePercent = 100;
        const baseSize = 1.125; // rem

        function updateSize() {
            if (content && display) {
                const newRem = baseSize * (currentSizePercent / 100);
                (content as HTMLElement).style.fontSize = `${newRem}rem`;
                display.textContent = `${currentSizePercent}%`;
            }
        }

        if (increaseBtn) {
            increaseBtn.addEventListener("click", () => {
                if (currentSizePercent < 150) {
                    currentSizePercent += 10;
                    updateSize();
                }
            });
        }

        if (decreaseBtn) {
            decreaseBtn.addEventListener("click", () => {
                if (currentSizePercent > 80) {
                    currentSizePercent -= 10;
                    updateSize();
                }
            });
        }

        // Enhance Code Blocks with MacOS style window and Copy button
        function enhanceCodeBlocks() {
            const codeBlocks = document.querySelectorAll(
                ".markdown-content pre",
            );

            codeBlocks.forEach((pre) => {
                // Prevent double wrapping
                if (pre.closest(".code-window")) return;

                // Create wrapper
                const wrapper = document.createElement("div");
                wrapper.className = "code-window";

                // Create header
                const header = document.createElement("div");
                header.className = "code-header";

                // Mac dots
                const dots = document.createElement("div");
                dots.className = "mac-dots";
                dots.innerHTML = `
                    <span class="mac-dot red"></span>
                    <span class="mac-dot yellow"></span>
                    <span class="mac-dot green"></span>
                `;

                // Copy button
                const copyBtn = document.createElement("button");
                copyBtn.className = "copy-btn";
                copyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    <span>Copy</span>
                `;

                copyBtn.addEventListener("click", async () => {
                    const code =
                        pre.querySelector("code")?.textContent ||
                        pre.textContent;
                    try {
                        if (code) {
                            await navigator.clipboard.writeText(code);
                        }
                        const originalHtml = copyBtn.innerHTML;
                        copyBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <span>Copied!</span>
                        `;
                        copyBtn.classList.add("copied");

                        setTimeout(() => {
                            copyBtn.innerHTML = originalHtml;
                            copyBtn.classList.remove("copied");
                        }, 2000);
                    } catch (err) {
                        console.error("Failed to copy!", err);
                    }
                });

                header.appendChild(dots);
                header.appendChild(copyBtn);

                // DOM Manipulation
                if (pre.parentNode) {
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                }
            });
        }

        // Run once DOM is ready
        enhanceCodeBlocks();
    </script>
</Layout>

<style>
    /* Scoped styles for the markdown content */
    .markdown-content {
        color: #374151; /* gray-700 */
        font-family: var(--font-sans);
        font-size: 1.125rem; /* 18px */
        line-height: 1.8;
    }

    /* Headings */
    .markdown-content :global(h1),
    .markdown-content :global(h2),
    .markdown-content :global(h3),
    .markdown-content :global(h4),
    .markdown-content :global(h5),
    .markdown-content :global(h6) {
        color: #111827; /* gray-900 */
        font-family: var(--font-heading);
        font-weight: 800;
        line-height: 1.2;
    }

    .markdown-content :global(h1) {
        font-size: 2.5rem;
        margin-top: 3rem;
        margin-bottom: 1.5rem;
    }
    .markdown-content :global(h2) {
        font-size: 2rem;
        margin-top: 3.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    .markdown-content :global(h3) {
        font-size: 1.5rem;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
    }
    .markdown-content :global(h4) {
        font-size: 1.25rem;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
    }

    /* Paragraphs and Text */
    .markdown-content :global(p) {
        margin-bottom: 1.5rem;
    }

    .markdown-content :global(strong) {
        font-weight: 700;
        color: #000;
    }

    /* Links */
    .markdown-content :global(a) {
        color: var(--color-primary, #ff4d00);
        text-decoration: underline;
        text-decoration-thickness: 2px;
        text-underline-offset: 4px;
        transition: all 0.2s ease;
    }

    .markdown-content :global(a:hover) {
        background-color: var(--color-primary, #ff4d00);
        color: white;
        text-decoration: none;
        padding: 0 4px;
        border-radius: 2px;
        margin: 0 -4px;
    }

    /* Images */
    .markdown-content :global(img) {
        display: block;
        margin: 3rem auto;
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
    }

    .markdown-content :global(img:hover) {
        transform: scale(1.01);
    }

    /* Code Window & Blocks */
    .markdown-content :global(.code-window) {
        background-color: #ffffff;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08);
        margin: 2.5rem 0;
        overflow: hidden;
    }

    .markdown-content :global(.code-header) {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background-color: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }

    .markdown-content :global(.mac-dots) {
        display: flex;
        gap: 6px;
    }

    .markdown-content :global(.mac-dot) {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .markdown-content :global(.mac-dot.red) {
        background-color: #ff5f56;
    }
    .markdown-content :global(.mac-dot.yellow) {
        background-color: #ffbd2e;
    }
    .markdown-content :global(.mac-dot.green) {
        background-color: #27c93f;
    }

    .markdown-content :global(.copy-btn) {
        display: flex;
        align-items: center;
        gap: 6px;
        background: white;
        border: 1px solid #e5e7eb;
        color: #64748b;
        font-family: var(--font-sans);
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .markdown-content :global(.copy-btn:hover) {
        background: #f1f5f9;
        color: #0f172a;
        border-color: #cbd5e1;
    }

    .markdown-content :global(.copy-btn.copied) {
        border-color: #22c55e;
        color: #15803d;
        background: #f0fdf4;
    }

    .markdown-content :global(pre) {
        background-color: #ffffff !important;
        color: #334155;
        font-family:
            "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
            Consolas, monospace;
        padding: 1.5rem;
        border: none !important;
        margin: 0 !important;
        white-space: pre-wrap; /* Better line wrapping on mobile */
        font-size: 0.95rem;
        line-height: 1.6;
    }

    .markdown-content :global(code) {
        font-family:
            "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
            Consolas, monospace;
        font-size: 0.9em;
    }

    /* Inline Code */
    .markdown-content :global(:not(pre) > code) {
        background-color: #f3f4f6;
        color: #db2777; /* pink-600 */
        padding: 0.25rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.875em;
        border: 1px solid #e5e7eb;
    }

    /* Blockquotes */
    .markdown-content :global(blockquote) {
        border-left: 4px solid var(--color-primary, #ff4d00);
        background: linear-gradient(to right, #fff5f5, transparent);
        padding: 1.5rem 2rem;
        margin: 2.5rem 0;
        font-style: italic;
        color: #4b5563;
        border-radius: 0 8px 8px 0;
    }

    .markdown-content :global(blockquote p:last-child) {
        margin-bottom: 0;
    }

    /* Lists */
    .markdown-content :global(ul),
    .markdown-content :global(ol) {
        margin-bottom: 1.5rem;
        padding-left: 2rem;
    }

    .markdown-content :global(li) {
        margin-bottom: 0.75rem;
        padding-left: 0.5rem;
    }

    .markdown-content :global(ul) {
        list-style-type: disc;
    }
    .markdown-content :global(ol) {
        list-style-type: decimal;
    }

    .markdown-content :global(li::marker) {
        color: var(--color-primary, #ff4d00);
        font-weight: bold;
    }

    /* Horizontal Rule */
    .markdown-content :global(hr) {
        margin: 4rem 0;
        border: 0;
        border-top: 1px solid #e5e7eb;
        position: relative;
    }

    .markdown-content :global(hr::after) {
        content: "•••";
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: var(--color-background, #fafafa);
        padding: 0 1rem;
        color: #9ca3af;
        letter-spacing: 0.5rem;
    }
</style>
